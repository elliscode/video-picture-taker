<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>&#58650; Hello my Baby &#58650;</title>
    <meta name="description" content="Plays a video while taking a picture, so you can get your baby to look at the camera" />
    <meta name="author" content="elliscode.com" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script data-ad-client="ca-pub-9981614688593327" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        #camera {
            position: absolute;
            bottom: 0px;
            left: 0px;
            width: 200px;
            height: 200px;
            z-index: 2;
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        #vimeo {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #shutter {
            position: absolute;
            bottom: 0px;
            right: 0px;
            width: 60px;
            height: 60px;
            z-index: 3;
            display: none;
        }

        #shutter>img {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: #000;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width=320 height=240></canvas>
    <video id="camera" muted playsinline autoplay></video>
    <div id="shutter"><img src="photo.png?v2"></div>
    <iframe id="vimeo" src="https://player.vimeo.com/video/531024797?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" width="640" height="360" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen title="Friendly Fish"></iframe>
</body>
<script>

    let i = 0;

    let inCallback = false;

    function handleTouchStart(evt) {
        if (inCallback) {
            evt.preventDefault();
            return;
        }
        inCallback = true;
        let canvas = document.getElementById('canvas');
        let settings = camera.srcObject.getTracks()[0].getSettings();
        canvas.width = settings.width;
        canvas.height = settings.height;
        let context = canvas.getContext('2d');
        context.drawImage(camera, 0, 0, canvas.width, canvas.height);
        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        var dataURL = canvas.toDataURL('image/jpeg', 0.9);
        // create temporary link  
        var tmpLink = document.createElement('a');
        tmpLink.download = (new Date().toISOString().replaceAll(/[^a-zA-Z0-9]+/g, '_')) + '.jpg'; // set the name of the download file 
        tmpLink.href = dataURL;

        // temporarily add link to body and initiate the download  
        document.body.appendChild(tmpLink);
        tmpLink.click();
        document.body.removeChild(tmpLink);
        inCallback = false;
        evt.preventDefault();
        return false;
    };

    function resize() {
        let settings = camera.srcObject.getTracks()[0].getSettings();
        let width = settings.width;
        let height = settings.height;
        camera.style.height = ((height / width) * 200) + 'px';

        let screenRatio = window.innerHeight / window.innerWidth;
        let videoRatio = 9 / 16;
        if (videoRatio < screenRatio) {
            vimeo.style.height = Math.ceil((videoRatio / screenRatio) * 100) + '%';
        } else {
            vimeo.style.height = '100%';
        }
        window.scrollTo(0, 0);
    }

    function init() {

        if (supported) {
            let constraints = {
                video: {
                    width: 4096,
                    facingMode: 'user'
                }
            };

            let userMedia = navigator.mediaDevices.getUserMedia(constraints);
            userMedia.then((stream) => {
                camera.srcObject = stream;
                resize();
                setInterval(resize, 100);
                shutter.addEventListener('touchstart', handleTouchStart, { passive: false });
                shutter.style.display = 'block';
                cancelButton.addEventListener('click', cancelCallback, { passive: false });
                okButton.addEventListener('click', okCallback, { passive: false });
            });
        }
    }

    const vimeo = document.getElementById('vimeo');
    const supported = 'mediaDevices' in navigator;
    const camera = document.getElementById('camera');
    const shutter = document.getElementById('shutter');

    init();

</script>

</html>